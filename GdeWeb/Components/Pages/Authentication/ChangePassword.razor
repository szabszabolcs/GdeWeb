@page "/change-password"
@attribute [AllowAnonymous]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using GdeWeb.Components.Layout
@using GdeWeb.Interfaces
@using GdeWeb.Services
@using GdeWebModels
@using System.ComponentModel.DataAnnotations
@using System.Text.RegularExpressions
@using Blazored.LocalStorage
@using Microsoft.AspNetCore.Components.Authorization

@inject IAuthService authService
@inject IUserService userService
@inject ISnackbarService snackbarService
@inject ILocalStorageService localStorage
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvider

<style>
    .footer {
        display: none;
    }

    /* A MudItem legyen "vágó" keret */
    .image-wrap {
        position: relative;
        /* VÁLASSZ EGYET a két magasság-koncepció közül: */
        /* 1) Töltse ki a viewport magasságát: */
        /* height: 100vh; */
        /* 2) VAGY: Töltse ki a szülő eleme magasságát:
             height: 100%;
             (ehhez a szülőknek is meg kell adni a magasságot, pl. a MudGrid-nek/fő konténernek) */

        overflow: hidden; /* jobbra (és minden irányba) levág */
    }

    /* A kép balra rögzítve, magasságban mindig kitölt */
    .image-fill-left {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%; /* mindig kitölti a konténer magasságát */
        width: auto; /* arányt tart, szélesség nőhet a konténeren túl */
        display: block; /* inline gap-ek elkerülése */
    }

    /* A kép középre igazítva, magasságot kitöltve */
    .image-fill-center {
        position: absolute;
        top: 50%;
        left: 50%;
        height: 100%;
        min-width: 100%;
        width: auto;
        transform: translate(-50%, -50%); /* középre helyezés */
        display: block;
    }

    .mud-card-content {
        align-content: center;
    }
</style>

<PageTitle>Jelszó megváltoztatása</PageTitle>

<div class="main-page container-center">
    @if (!PageLoading)
    {
        <!-- BODY -->
        <MudGrid Justify="Justify.SpaceEvenly" Class="pa-0 h-100" Spacing="0">

            <MudItem xs="0" sm="0" md="6" lg="8" xl="9" xxl="10" Style="align-content: center; text-align: center;" Class="image-wrap">

                <BlazorAnimate.Animate Animation="Animations.Fade" Delay="TimeSpan.FromSeconds(MainLayout.animationDelay)" Duration="TimeSpan.FromSeconds(MainLayout.animationDuration)" style="height: 100%">
                    <MudImage Src="img/auth_ai_large.jpg" Alt="AI" Elevation="25" Class="image-fill-center" />
                </BlazorAnimate.Animate>

            </MudItem>

            <MudItem xs="12" sm="12" md="6" lg="4" xl="3" xxl="2" Style="align-content: center; text-align: center;">

                <BlazorAnimate.Animate Animation="Animations.ZoomIn" Delay="TimeSpan.FromSeconds(MainLayout.animationDelay)" Duration="TimeSpan.FromSeconds(MainLayout.animationDuration)" style="height: 100%">

                    <MudCard Elevation="0" Class="card-max h-100">
                        <MudCardContent>

                            <MudForm Model="@model" @ref="form" @bind-Errors="@errors">

                                <MudText Align="Align.Left" Typo="Typo.h1" Class="card-title" Color="Color.Secondary">
                                    Jelszó megváltoztatása
                                </MudText>

                                <MudText Align="Align.Left" Typo="Typo.h5" Class="card-subtitle" Style="margin-bottom: 40px;">
                                    Állítsa vissza elfelejtett jelszavát!
                                </MudText>

                                <MudTextField T="string" Class="card-input" @bind-Value="@model.Password" Label="Jelszó létrehozása" Variant="Variant.Text"
                                              Required="@required" InputType="@inputPasswordType" Adornment="Adornment.End" AdornmentColor="Color.Primary"
                                              AdornmentIcon="@(inputPasswordType == InputType.Password ? @Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                              OnAdornmentClick="@(() => ChangeInputPasswordType())" OnlyValidateIfDirty="true" ErrorText=""
                                              Validation="@(new Func<string, string>(PasswordMatch))" Disabled="isLoading"></MudTextField>

                                <MudTextField T="string" Class="card-input" @bind-Value="@model.ConfirmPassword" Label="Jelszó megerősítése" Variant="Variant.Text"
                                              Required="@required" InputType="@inputConfirmationPasswordType" Adornment="Adornment.End" AdornmentColor="Color.Primary"
                                              AdornmentIcon="@(inputConfirmationPasswordType == InputType.Password ? @Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                              OnAdornmentClick="@(() => ChangeInputConfirmPasswordType())" OnlyValidateIfDirty="true" ErrorText=""
                                              Validation="@(new Func<string, string>(ConfirmPasswordMatch))" Disabled="isLoading"></MudTextField>

                                <MudButton Class="card-button" Variant="Variant.Filled" Color="Color.Primary" DropShadow="true" OnClick="@Submits" Style="margin-top: 40px;" Disabled="isLoading">Küldés</MudButton>

                                <MudText Align="Align.Left" Typo="Typo.body1" Class="card-links">
                                    Már van fiókja?
                                    <MudLink OnClick="@(() => MainLayout.GoTo("signin"))" Underline="Underline.Always" Color="Color.Primary" Typo="Typo.body1" Class="card-link">Kattintson ide</MudLink>
                                </MudText>

                                <MudText Align="Align.Left" Typo="Typo.body1" Class="card-links">
                                    Még nincs fiókja?
                                    <MudLink OnClick="@(() => MainLayout.GoTo("signup"))" Underline="Underline.Always" Color="Color.Primary" Typo="Typo.body1" Class="card-link">Kattintson ide</MudLink>
                                </MudText>

                                <MudText Align="Align.Left" Typo="Typo.body1" Class="card-links">
                                    A regisztrációval elfogadja a
                                    <MudLink OnClick="@(() => MainLayout.GoTo("privacy"))" Underline="Underline.Always" Color="Color.Primary" Typo="Typo.body1" Class="card-link">Felhasználási feltételeket</MudLink>
                                </MudText>

                            </MudForm>

                        </MudCardContent>
                    </MudCard>

                </BlazorAnimate.Animate>

            </MudItem>

        </MudGrid>

    }
    else
    {
        <!-- LOADING -->
        <div class="loading-center">
            <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
        </div>
    }
</div>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; } = default!;

    // ?token=...  (query string)
    [Parameter, SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }
    private string? _lastProcessedToken;

    // LOADING PARAMETERS
    private bool PageLoading = true; // true

    // IS LOADING
    private bool isLoading = false;

    // LOGIN USER MODEL
    private LoginUserModel loginUser { get; set; } = default!;

    // FORM
    private ChangeModel model = new ChangeModel();
    private string[] errors = { };
    private MudForm form = new MudForm();
    private bool required { get; set; } = false;
    private InputType inputPasswordType { get; set; } = InputType.Password;
    private InputType inputConfirmationPasswordType { get; set; } = InputType.Password;


    // A feltételek a karakterláncnak 8 és 20 karakter között kell lennie.
    // A karakterláncnak legalább egy számot kell tartalmaznia.
    // A karakterláncnak legalább egy nagybetűt kell tartalmaznia.
    // A karakterláncnak legalább egy kisbetűt kell tartalmaznia.

    // ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,20}$

    // Ha legalább egy speciális karaktert is szeretnénk igényelni, próbálják ki ezt:

    // ^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,20}$

    /// <summary>
    /// PAGE LOAD
    /// </summary>
    #region PAGE LOAD
    protected override async Task OnInitializedAsync()
    {
        // Ide csak olyan kezdeti dolgok kerüljenek, amik függetlenek a tokentől.
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            PageLoading = true;

            // Kötelező token esetén korai visszairányítás
            if (string.IsNullOrWhiteSpace(Token))
            {
                navigationManager.NavigateTo("/");
                return;
            }

            // Ha nincs token, semmi teendő — az oldal simán betölt.
            // if (string.IsNullOrWhiteSpace(Token))
            // {
            //     PageLoading = false;
            //     return;
            // }

            // Normalizálás (általában felesleges, de ártani nem árt)
            var token = Uri.UnescapeDataString(Token);

            // Ha ugyanazt a tokent már feldolgoztuk, ne kérjünk le újra
            if (string.Equals(token, _lastProcessedToken, StringComparison.Ordinal))
                return;

            _lastProcessedToken = token;   // megjegyezzük, hogy ne fusson újra

            Token = token;
        }
        catch (Exception ex)
        {
            snackbarService.ShowSnackbar(Severity.Error, $"Hiba történt: {ex.Message}", MainLayout.pageWidth);
            navigationManager.NavigateTo("/");
        }
        finally
        {
            PageLoading = false;
        }
    }

    // Ha nem használsz benne logikát, ez az override el is hagyható
    //protected override Task OnAfterRenderAsync(bool firstRender) => Task.CompletedTask;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Itt már ne foglalkozzunk paraméterrel/token-nel.
        // Ha első render után szeretnél UI-t finomhangolni, megteheted,
        // de ne indíts itt új auth folyamatot.
        if (firstRender)
        {
            // Token használható itt
            if (!string.IsNullOrEmpty(Token))
            {
                loginUser = await authService.GetUserFromToken(new LoginTokenModel() { Token = Token });
                if (loginUser is null || !loginUser.Result.Success)
                {
                    snackbarService.ShowSnackbar(Severity.Error, "Érvénytelen vagy lejárt token.", MainLayout.pageWidth);
                    navigationManager.NavigateTo("/");
                    return;
                }

                // Token eltárolása – felesleges törölni előtte, a Set felülír
                await localStorage.SetItemAsync("token", Token);
            }
        }
    }
    #endregion


    /// <summary>
    /// BUTTON FUNCTIONS
    /// </summary>
    #region BUTTON FUNCTIONS
    private async Task Submits()
    {
        try
        {
            isLoading = true;                // kurzor be
            StateHasChanged();

            // Required validation
            required = true;
            StateHasChanged();
            await Task.Delay(100);
            // run the standard Validation
            await form.Validate();
            // Fake a database async call to check if the user exists
            await Task.Delay(100);
            //Just for Testing trip validation
            if (form.IsValid)
            {
                if (loginUser != null)
                {
                    ProfilePasswordModel resultModel = await userService.ModifyProfilePassword(loginUser.Id, model.Password);
                    if (resultModel != null)
                    {
                        if (resultModel.Result.Success)
                        {
                            snackbarService.ShowSnackbar(Severity.Success, "Minden mező rendben van! Jelszó megváltoztatása.", MainLayout.pageWidth);
                            await Task.Delay(3000);
                            navigationManager.NavigateTo("/");
                        }
                        else
                        {
                            snackbarService.ShowSnackbar(Severity.Error, resultModel.Result.ErrorMessage, MainLayout.pageWidth);
                            StateHasChanged();
                        }
                    }
                    else
                    {
                        snackbarService.ShowSnackbar(Severity.Error, "Hiba a lekérdezés során!", MainLayout.pageWidth);
                    }
                }
                else
                {
                    snackbarService.ShowSnackbar(Severity.Error, "A tokenhez tartozó felhasználó nem található!", MainLayout.pageWidth);
                }
            }
            else
            {
                foreach (String error in errors)
                {
                    if (!string.IsNullOrEmpty(error))
                    {
                        snackbarService.ShowSnackbar(Severity.Error, error, MainLayout.pageWidth);
                    }
                }
                await Task.Delay(1000); // Várakozás 1 másodpercig
                form.ResetValidation();
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            snackbarService.ShowSnackbar(Severity.Error, $"Hiba történt a művelet során: {ex.Message.ToString()}", MainLayout.pageWidth);
        }
        finally
        {
            isLoading = false;              // kurzor ki
            StateHasChanged();
        }
    }
    #endregion


    /// <summary>
    /// VALIDATION FUNCTIONS
    /// </summary>
    #region VALIDATION FUNCTIONS
    private string PasswordMatch(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "A jelszó megadása kötelező.";
        if (value.Length < 8 || value.Length > 20)
            return "A jelszónak 8 és 20 karakter hosszúnak kell lennie.";
        if (!Regex.IsMatch(value, @"^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\da-zA-Z]).{8,20}$"))
            return @"A jelszónak meg kell felelnie a következő követelményeknek!<br/>
            <ul>
                <li>A jelszónak 8 és 20 karakter hosszúnak kell lennie</li> 
                <li>Tartalmaznia kell legalább egy számjegyet</li> 
                <li>Tartalmaznia kell legalább egy nagybetűt</li> 
                <li>Tartalmaznia kell legalább egy kisbetűt</li> 
            </ul>";
        return String.Empty;
    }

    private string ConfirmPasswordMatch(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return "A jelszó megerősítése kötelező.";
        if (value.Length < 8 || value.Length > 20)
            return "A jelszónak minimum 8, maximum 20 karakter hosszúnak kell lennie.";
        if (value != model.Password)
            return "A jelszavaknak meg kell egyezniük.";
        return String.Empty;
    }

    private async Task ChangeInputPasswordType()
    {
        await Task.Delay(1);
        if (inputPasswordType == InputType.Password)
            inputPasswordType = InputType.Text;
        else
            inputPasswordType = InputType.Password;
    }

    private async Task ChangeInputConfirmPasswordType()
    {
        await Task.Delay(1);
        if (inputConfirmationPasswordType == InputType.Password)
            inputConfirmationPasswordType = InputType.Text;
        else
            inputConfirmationPasswordType = InputType.Password;
    }
    #endregion


    /// <summary>
    /// CHANGE MODEL
    /// </summary>
    #region CHANGE MODEL
    public class ChangeModel
    {
        public string Password { get; set; } = default!;

        public string ConfirmPassword { get; set; } = default!;
    }
    #endregion
}
