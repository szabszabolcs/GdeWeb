@page "/onboarding"
@attribute [Authorize]

@using GdeWeb.Components.Layout
@using GdeWeb.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using GdeWebModels
@using GdeWeb.Interfaces
@using MudExtensions

@inject AuthenticationStateProvider authenticationStateProvider
@inject IUserService userService
@inject ISnackbarService snackbarService
@inject NavigationManager navigationManager
@inject ILocalStorageService localStorage

<PageTitle>Üdvözlés</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-8">
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-4">
                Üdvözöljük a rendszerben!
            </MudText>
            
            <MudText Typo="Typo.body1" Align="Align.Center" Class="mb-6">
                Néhány gyors lépés, és készen áll!
            </MudText>
            
            <MudStepper @ref="stepper" Color="Color.Primary">
                <MudStep Title="Személyes adatok">
                    <MudTextField 
                        Label="Keresztnév" 
                        @bind-Value="@firstName" 
                        Required="true"
                        Variant="Variant.Outlined"
                        Class="mb-3" />
                    <MudTextField 
                        Label="Vezetéknév" 
                        @bind-Value="@lastName" 
                        Required="true"
                        Variant="Variant.Outlined" />
                </MudStep>
                
             @*    <MudStep Title="Beállítások">
                    <MudSelect 
                        Label="Nyelv" 
                        @bind-Value="@selectedLanguage"
                        Variant="Variant.Outlined">
                        <MudSelectItem Value="hu">Magyar</MudSelectItem>
                        <MudSelectItem Value="en">English</MudSelectItem>
                    </MudSelect>
                </MudStep> *@
                
                <MudStep Title="Befejezés">
                    <MudText Typo="Typo.body1" Align="Align.Center">
                        Minden kész! Kattintson a "Befejezés" gombra.
                    </MudText>
                </MudStep>
            </MudStepper>
            
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                @* <MudButton 
                    OnClick="@PreviousStep" 
                    Disabled="@(stepper.ActiveIndex == 0)"
                    Variant="Variant.Text">
                    Előző
                </MudButton>
                <MudButton 
                    Variant="Variant.Filled" 
                    Color="Color.Primary"
                    OnClick="@NextStep"
                    Disabled="@isCompleting">
                    @(stepper.ActiveIndex == stepper.Steps.Count - 1 ? "Befejezés" : "Következő")
                </MudButton> *@
            </MudStack>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; } = default!;
    
    private MudStepper stepper = new();
    private string firstName = "";
    private string lastName = "";
    private string selectedLanguage = "hu";
    private bool isCompleting = false;
    
    protected override async Task OnInitializedAsync()
    {
        // Ellenőrizzük, hogy be van-e jelentkezve
        var state = await authenticationStateProvider.GetAuthenticationStateAsync();
        if (state.User?.Identity?.IsAuthenticated != true)
        {
            navigationManager.NavigateTo("/signin");
            return;
        }
        
        // Felhasználó adatok betöltése
        var user = await ((CustomAuthentication)authenticationStateProvider).GetAuthenticatedUserAsync();
        
        if (user != null && user.Id > 0)
        {
            firstName = user.FirstName;
            lastName = user.LastName;
        }
    }
    
    // private void PreviousStep()
    // {
    //     if (stepper.ActiveIndex > 0)
    //         stepper.Previous();
    // }
    
    // private async Task NextStep()
    // {
    //     if (stepper.ActiveIndex < stepper.Steps.Count - 1)
    //     {
    //         // Validáció az első lépésnél
    //         if (stepper.ActiveIndex == 0)
    //         {
    //             if (string.IsNullOrWhiteSpace(firstName) || string.IsNullOrWhiteSpace(lastName))
    //             {
    //                 snackbarService.ShowSnackbar(
    //                     Severity.Warning, 
    //                     "Kérjük, töltse ki a kötelező mezőket!", 
    //                     MainLayout.pageWidth);
    //                 return;
    //             }
    //         }
            
    //         stepper.Next();
    //     }
    //     else
    //     {
    //         await CompleteOnboarding();
    //     }
    // }
    
    private async Task CompleteOnboarding()
    {
        try
        {
            isCompleting = true;
            StateHasChanged();
            
            // TODO: User adatok frissítése API-n keresztül
            // Jelenleg csak az onboarding flag-et állítjuk be
            // A teljes implementációhoz szükség van egy API endpoint-ra
            
            snackbarService.ShowSnackbar(
                Severity.Success, 
                "Onboarding sikeresen befejezve!", 
                MainLayout.pageWidth);
            
            // Kis késleltetés, hogy lássa az üzenetet
            await Task.Delay(1000);
            
            navigationManager.NavigateTo("/dashboard");
        }
        catch (Exception ex)
        {
            snackbarService.ShowSnackbar(
                Severity.Error, 
                $"Hiba: {ex.Message}", 
                MainLayout.pageWidth);
        }
        finally
        {
            isCompleting = false;
            StateHasChanged();
        }
    }
}

