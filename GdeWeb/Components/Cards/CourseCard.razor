@using GdeWeb.Components.Layout
@using GdeWeb.Dialogs
@using GdeWeb.Interfaces
@using GdeWebModels
@using MudBlazor

@inject ITrainingService trainingService
@inject IDialogService dialogService
@inject ISnackbarService snackbarService

<MudCard Class="@((eventModel is not null && quizModel is not null) ? "element-card element-card-success" : "element-card")"
         Elevation="0"
         Style="@(!Editor ? "cursor:pointer; --element-accent: var(--mud-palette-secondary);" : "--element-accent: var(--mud-palette-secondary);")"
         @onclick="@(() => !Editor ? ShowCourse(Course) : ShowCourse(new CourseModel()))">

    <div class="element-row element-row">
        <!-- BAL: ikonok csak ha VAN tartalom -->
        <div class="element-left element-icons">
            @if (!string.IsNullOrEmpty(Course.CourseTitle))
            {
                @* Videó ikon CSAK akkor, ha CourseMedia nem üres *@
                @if (!string.IsNullOrWhiteSpace(Course?.CourseMedia))
                {
                    <span class="element-icon-wrap">
                        <MudTooltip Text="Videó">
                            <MudIcon Icon="@Icons.Material.Filled.VideoLibrary" Class="element-icon" />
                        </MudTooltip>
                    </span>
                }

                @* HTML ikon CSAK akkor, ha CourseFileText nem üres *@
                @if (!string.IsNullOrWhiteSpace(Course?.CourseFileText))
                {
                    <span class="element-icon-wrap">
                        <MudTooltip Text="HTML">
                            <MudIcon Icon="@Icons.Material.Filled.Language" Class="element-icon" />
                        </MudTooltip>
                    </span>
                }

                @if (!Editor)
                {
                    @* A kártyán lévő általános @onclick mindig lefut, 
                        ezért a kvíz ikonra kattintva a kártya kattintása is lefutna.

                        Állítsuk meg az esemény terjedését az ikon(hoz közeli) elemben.
                        Wrap - oljuk be az ikont egy span - be, és tegyük rá az event-modifier(eke)t: *@
                    <span style="--element-accent: var(--mud-palette-primary);" class="element-icon-wrap"
                          @onclick:stopPropagation="true"
                          @onclick:preventDefault="true"
                          @onclick="@(() => CourseQuiz(Course))">
                        <MudTooltip Text="Kvíz">
                            <MudIcon Icon="@Icons.Material.Filled.Quiz" Color="Color.Primary" Class="element-icon" />
                        </MudTooltip>
                    </span>
                }
            }
            else
            {
                <span class="element-icon-wrap">
                    <MudTooltip Text="Generálás folyamatban">
                        <MudIcon Icon="@Icons.Material.Filled.GeneratingTokens" Class="element-icon" />
                    </MudTooltip>
                </span>
            }
        </div>

        <!-- KÖZÉP: cím + leírás + info -->
        <div class="element-mid">
            @if (string.IsNullOrEmpty(Course.CourseTitle))
            {
                <MudSpacer />

                <MudText Typo="Typo.body1" Class="element-title">@Course.CourseAiRequest.Topic</MudText>

                <MudText Typo="Typo.body1" Class="element-title element-pulse mt-2" Style="color: var(--mud-palette-secondary)">Generálás folyamatban...</MudText>

                <MudSpacer />
            }
            else
            {
                <MudText Typo="Typo.body1" Class="element-title">@Course.CourseTitle</MudText>

                <MudSpacer />

                <MudText Typo="Typo.caption" Class="element-desc">
                    @Course.CourseDescription
                </MudText>

                <MudSpacer />

                <MudText Typo="Typo.caption" Class="element-count mt-1" Style="font-style: italic;">
                    @($"{(string.IsNullOrWhiteSpace(Course?.CourseMedia) ? "Csak szöveg" : "Videó és szöveg")} • {TimeSpan.FromSeconds(Course.CourseMediaDuration):hh\\:mm\\:ss}")
                </MudText>

                @if (!Editor)
                {
                    <style>
                        .not-show {
                            color: #DB3181;
                        }
                    </style>

                    <MudSpacer />
                    <MudText Typo="Typo.caption" Class="@(eventModel is not null ? "element-show mt-1" : "element-show mt-1 not-show")">
                        @(eventModel is null ? "Még nem tekinteted meg." : $"Megtekintve: {eventModel.ModificationDate.ToString("yyyy-MM-dd HH:mm")}")
                    </MudText>

                    <MudSpacer />
                    <MudText Typo="Typo.caption" Class="@(quizModel is not null ? "element-show mt-1" : "element-show mt-1 not-show")">
                        @(quizModel is null ? "Még nem végeztél kvízt." : $"Legjobb kvíz: {Math.Round(((double)quizModel.QuizResult / quizModel.QuizQuestion) * 100, 2)}% - {quizModel.ModificationDate.ToString("yyyy-MM-dd HH:mm")}")
                    </MudText>
                }
            }
        </div>

        <!-- JOBB: gombok (editor módban) -->
        @if (Editor)
        {
            <div class="element-right">
                @if (!string.IsNullOrEmpty(Course.CourseTitle))
                {
                    <MudTooltip Text="Megtekintés">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                       Class="element-action"
                                       OnClick="@(() => ShowCourse(Course))" />
                    </MudTooltip>

                    <MudTooltip Text="Szerkesztés">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                       Class="element-action"
                                       OnClick="@(() => EditCourse(Course))" />
                    </MudTooltip>
                }

                <MudTooltip Text="Törlés">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                   Class="element-action"
                                   OnClick="@(() => RemoveCourse(Course))" />
                </MudTooltip>
            </div>
        }
    </div>
</MudCard>

@code {
    [CascadingParameter] public MainLayout MainLayout { get; set; } = default!;

    [Parameter]
    public CourseModel? Course { get; set; } = default!;

    [Parameter]
    public bool Editor { get; set; } = default!;

    [Parameter] 
    public EventCallback ChangeModifyMethod { get; set; }

    private UserEventModel? eventModel { get; set; }

    private UserQuizModel? quizModel { get; set; }

    /// <summary>
    /// PAGE LOAD
    /// </summary>
    #region PAGE LOAD
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            eventModel = MainLayout.loggedUser.UserData.Courses.Where(w => w.CourseId == Course.CourseId).FirstOrDefault();
            quizModel = MainLayout.loggedUser.UserData.Quizzes
                .Where(w => w.CourseId == Course.CourseId && w.QuizResult > 0 && w.QuizQuestion > 0)
                .OrderByDescending(q => (double)q.QuizResult / q.QuizQuestion)  // legmagasabb pontarány
                .ThenByDescending(q => q.ModificationDate)                      // holtversenynél a frissebb
                .FirstOrDefault();
            StateHasChanged();
        }
    }
    #endregion

    public async Task ShowCourse(CourseModel course)
    {
        if (course?.CourseId is 0) return;

        await Task.Delay(10);

        // Saját néző dialogod
        await MainLayout.ShowCourseViewDialog(Course ?? new CourseModel());
    }

    private async Task EditCourse(CourseModel course)
    {
        DialogOptions options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            FullWidth = true,
            MaxWidth = MaxWidth.ExtraSmall,
            //MaxWidth = MaxWidth.Large,
            //FullScreen = true,
            BackdropClick = false
        };

        var parameters = new DialogParameters { ["Course"] = course };

        var dialog = await dialogService.ShowAsync<CourseDialog>("Kurzus módosítása", parameters, options);
        DialogResult? dialogResult = await dialog.Result;
        if (dialogResult is not null && !dialogResult.Canceled)
            await ChangeModifyMethod.InvokeAsync();
    }

    private async Task RemoveCourse(CourseModel course)
    {
        var options = new DialogOptions { CloseButton = false, MaxWidth = MaxWidth.ExtraLarge };
        var parameters = new DialogParameters { ["message"] = "Biztosan törölni szeretné a kurzust?" };

        var dialog = await dialogService.ShowAsync<QuestionDialog>("Kurzus eltávolítása", parameters, options);
        DialogResult? dialogResult = await dialog.Result;
        if (dialogResult is not null && !dialogResult.Canceled)
        {
            var res = await trainingService.DeleteCourse(course);  // <- csak Id megy
            if (res.Success)
            {
                snackbarService.ShowSnackbar(Severity.Success, "Kurzus sikeresen eltávolítva!", MainLayout.pageWidth);
                await ChangeModifyMethod.InvokeAsync();
            }
            else
            {
                snackbarService.ShowSnackbar(Severity.Error, res.ErrorMessage, MainLayout.pageWidth);
            }
        }
    }

    public async Task CourseQuiz(CourseModel course)
    {
        if (course?.CourseId is 0) return;

        await Task.Delay(10);

        await MainLayout.GoTo($"/quiz?cid={course.CourseId}");
    }
}

<style>
    .cat-icon-wrap {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        border: 1px solid rgba(15,23,42,.08);
        margin: 4px 0;
    }

    .cat-icon {
        color: var(--mud-palette-secondary);
    }
</style>
