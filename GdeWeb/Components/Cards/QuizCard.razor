@using GdeWeb.Components.Layout
@using GdeWebModels
@inherits ComponentBase

@inject IJSRuntime jsRuntime

@* -------------------------------------------------------------
   QUIZCARD – Egyszerűsített, három fázisos kvízkomponens
   Fázisok: Intro -> Quiz -> Finished
   Bemenet: IEnumerable<QuizModel> (lista)
   Kimenet: UserQuizModel az OnFinish eseményen
   ------------------------------------------------------------- *@

<div class="quizcard-wrapper" style="display:grid;gap:16px;max-width:720px;width:calc(100% - 12px);margin:auto;">

    <!-- SFX – előtöltve, kis késleltetés nélkül -->
    <audio id="sfx-level-start" src="/sfx/level_start.mp3" preload="auto"></audio>
    <audio id="sfx-level-complete" src="/sfx/level_complete.mp3" preload="auto"></audio>
    <audio id="sfx-answer-success" src="/sfx/answer_success.mp3" preload="auto"></audio>
    <audio id="sfx-answer-wrong" src="/sfx/answer_wrong.mp3" preload="auto"></audio>

    @if (Phase == PhaseState.Intro)
    {
        <div class="card" style="padding:20px;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.08);gap:12px;width:100%;">
            @if (!string.IsNullOrEmpty(Course.CourseTitle))
            {
                <div style="font-weight:800;font-size:22px;">@Course.CourseTitle</div>
                <div style="font-weight:600;font-size:22px;">Kurzus kvíz – felkészültél?</div>
            }
            else
            {
                <div style="font-weight:600;font-size:22px;">Napi kvíz – felkészültél?</div>
            }
            <div style="opacity:.8;">Kérdések száma: <strong>@Total</strong></div>
            <div style="display:flex;gap:8px;">
                <button @onclick="StartQuiz"
                        style="padding:10px 16px;border-radius:12px;border:none;background:#22c55e;color:white;font-weight:700;">
                    Kezdjük!
                </button>
            </div>

            <div class="quiz-anim" style="width:100%;height:160px;display:flex;align-items:center;justify-content:center;gap:16px;">
                <LottieCard @ref="_man" Path="/lotties/question_sir.json" Width="160" Height="160" Autoplay="true" Loop="true" Speed="1.0" />
                <LottieCard @ref="_lady" Path="/lotties/question_lady.json" Width="160" Height="160" Autoplay="true" Loop="true" Speed="1.0" />
            </div>

@*             <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                <input id="quiz-sound-intro" type="checkbox" @bind="SoundsOn" />
                <label for="quiz-sound-intro">Hangok engedélyezése</label>
            </div> *@
        </div>
    }
    else if (Phase == PhaseState.Finished)
    {
        <div class="card" style="padding:20px;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.08);">
            <div style="display:flex;flex-direction:column;gap:12px;align-items:flex-start;">
                <div style="font-weight:800;font-size:22px;">Eredmény</div>
                <div style="opacity:.8;">Pontszám: <strong>@Score</strong> / @Total</div>
                <div style="opacity:.8;">Helyes válaszok aránya: <strong>@(Math.Round(100.0 * Score / Math.Max(1, Total)))%</strong></div>
                <div class="controls" style="display:flex;gap:8px;margin-top:8px;margin: auto;">
                    <button @onclick="ResetAll" style="padding:10px 16px;border-radius:12px;border:1px solid #e5e7eb;background:white;">Újrakezdés</button>
                    <button @onclick="Finish" style="padding:10px 16px;border-radius:12px;border:none;background:#22c55e;color:white;font-weight:700;">Befejezés</button>
                </div>
            </div>

            <div class="quiz-anim" style="width:100%;height:180px;position:relative;display:flex;justify-content:center;align-items:center;gap:12px;margin-top:8px;">
                <LottieCard @ref="_confetti" Path="/lotties/confetti.json" Width="720" Height="360" Autoplay="true" Loop="false" Speed="1.4" />
                <LottieCard @ref="_trophy" Path="/lotties/trophy.json" Width="220" Height="220" Autoplay="true" Loop="false" Speed="1.2" />
            </div>
        </div>
    }
    else if (Phase == PhaseState.Quiz && Total > 0)
    {
        <div class="quiz-anim" style="width:100%;height:160px;position:relative;display:flex;justify-content:center;align-items:center;gap:16px;">
            @if (ShowCelebration)
            {
                <LottieCard @ref="_confetti" Path="/lotties/confetti.json" Width="720" Height="360" Autoplay="true" Loop="false" Speed="1.0" />
                <LottieCard @ref="_badge" Path="/lotties/success-badge.json" Width="160" Height="160" Autoplay="true" Loop="false" Speed="1.2" />
            }
            else
            {
                @if (QuestionLady)
                {
                    <LottieCard @ref="_lady" Path="/lotties/question_lady.json" Width="160" Height="160" Autoplay="true" Loop="true" Speed="1.0" />
                }
                else
                {
                    <LottieCard @ref="_man" Path="/lotties/question_sir.json" Width="160" Height="160" Autoplay="true" Loop="true" Speed="1.0" />
                }
            }
        </div>

        <div class="duo-progress mt-3">
            <div class="duo-progress__fill" style="width:@($"{ProgressValue}%")"></div>
        </div>

        <div class="card" style="padding:16px;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.08);">
            <div class="flex" style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
                <div style="font-weight:700;font-size:20px;">Kérdés @(CurrentIndex + 1) / @Total</div>
                <div style="opacity:.7;">Pont: <strong>@Score</strong></div>
            </div>
            <div class="mt-2" style="margin-top:8px;font-size:18px;">
                @CurrentQuestionText
            </div>
        </div>

        <div class="answers" style="display:grid;grid-template-columns: 1fr 1fr;gap:12px;">
            @{
                var correctIndex = CurrentOptions.FindIndex(o => o.IsCorrect);
            }
            @for (int i = 0; i < CurrentOptions.Count; i++)
            {
                var option = CurrentOptions[i];
                var isWrong = WrongShakeIndex == i;
                var baseStyle = "padding:14px 16px;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.06);background:#fff;";
                var correctStyle = (Answered && i == correctIndex) ? "outline:2px solid #31c48d;background:#ecfdf5;" : "";
                var wrongStyle = (Answered && i == SelectedIndex && i != correctIndex) ? "outline:2px solid #f05252;background:#fef2f2;" : "";
                var cls = $"answer-card {(isWrong ? "shake" : "")}";
                var idx = i; // closure fix

                <div class="@cls" style="@baseStyle @correctStyle @wrongStyle" @onclick="() => OnSelect(idx)">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:28px;height:28px;display:grid;place-items:center;border-radius:50%;background:#f4f4f5;font-weight:700;">@(i + 1)</div>
                        <div>@option.Text</div>
                    </div>
                </div>
            }
        </div>

        <div class="controls" style="display:flex;justify-content:space-between;gap:12px;width:100%;">
            <button @onclick="CancelQuiz" style="padding:10px 16px;border-radius:12px;border:1px solid #e5e7eb;background:white;">Megszakítás</button>
            <button @onclick="ResetAll" style="padding:10px 16px;border-radius:12px;border:1px solid #e5e7eb;background:white;">Újrakezdés (újrakeverve)</button>
            <button @onclick="Next" disabled="@(!Answered)" style="padding:10px 16px;border-radius:12px;border:none;background:#22c55e;color:white;font-weight:700;">Következő →</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px;margin:6px 0;width: 100%;">
            <input id="quiz-sound-quiz" type="checkbox" @bind="SoundsOn" />
            <label for="quiz-sound-quiz">Hangok engedélyezése</label>
        </div>
    }
    else
    {
        <div class="card" style="padding:16px;border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.08);">
            <div>Nincs megjeleníthető kérdés.</div>
        </div>
    }
</div>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; } = default!;

    // --- FÁZISOK ---
    private enum PhaseState { Intro, Quiz, Finished }
    private PhaseState Phase = PhaseState.Intro;

    // --- PARAMÉTEREK / ESEMÉNYEK ---
    [Parameter] public IEnumerable<QuizModel> Items { get; set; } = Enumerable.Empty<QuizModel>();
    [Parameter] public CourseModel? Course { get; set; } = new CourseModel();
    [Parameter] public bool ShuffleQuestions { get; set; } = true;
    [Parameter] public bool ShuffleOptions { get; set; } = true;
    [Parameter] public EventCallback OnRequestDailyRefresh { get; set; } // napi újrasorsolás kérése a parenttől
    [Parameter] public EventCallback<UserQuizModel> OnFinish { get; set; }

    // --- Állapot ---
    // Egy kérdés: (QuizModel Source, List<(string Text, bool IsCorrect)> Options)
    private List<(QuizModel Source, List<(string Text, bool IsCorrect)> Options)> Questions = new();
    private int CurrentIndex = 0;
    private int Score = 0;

    private bool Answered = false;
    private int? SelectedIndex = null;
    private int WrongShakeIndex = -1;

    private bool ShowCelebration = false;

    private LottieCard? _confetti;
    private LottieCard? _badge;
    private LottieCard? _trophy;
    private LottieCard? _man;
    private LottieCard? _lady;

    private bool QuestionLady = true;

    private (QuizModel Source, List<(string Text, bool IsCorrect)> Options) Current => Questions[Math.Clamp(CurrentIndex, 0, Math.Max(0, Questions.Count - 1))];
    private string CurrentQuestionText => string.IsNullOrWhiteSpace(Current.Source.QuizQuestion) ? "(nincs kérdés)" : Current.Source.QuizQuestion;
    private List<(string Text, bool IsCorrect)> CurrentOptions => Current.Options;

    private int Total => Questions.Count;

    private bool SoundsOn { get; set; } = true; // alapból BE

    private int ProgressValue
        => Phase switch
        {
            PhaseState.Intro => 0,
            PhaseState.Quiz => Total <= 0 ? 0 : (int)Math.Round(100.0 * Math.Min(CurrentIndex, Total) / Total),
            PhaseState.Finished => 100,
            _ => 0
        };

    // --- Életciklus ---
    protected override void OnParametersSet()
    {
        RebuildQuestions(Items);
    }

    private void RebuildQuestions(IEnumerable<QuizModel> input)
    {
        var rng = new Random();

        var list = new List<(QuizModel Source, List<(string Text, bool IsCorrect)> Options)>();
        foreach (var m in input ?? Enumerable.Empty<QuizModel>())
        {
            var opts = new List<(string Text, bool IsCorrect)>();

            void AddIfAny(string s, bool isCorrect)
            {
                if (!string.IsNullOrWhiteSpace(s))
                    opts.Add((s, isCorrect));
            }

            AddIfAny(m.QuizAnswer1, EqualsCI(m.QuizAnswer1, m.QuizSuccess));
            AddIfAny(m.QuizAnswer2, EqualsCI(m.QuizAnswer2, m.QuizSuccess));
            AddIfAny(m.QuizAnswer3, EqualsCI(m.QuizAnswer3, m.QuizSuccess));
            AddIfAny(m.QuizAnswer4, EqualsCI(m.QuizAnswer4, m.QuizSuccess));

            if (opts.Count == 0) opts.Add(("(nincs elérhető válasz)", true));

            if (ShuffleOptions) opts = opts.OrderBy(_ => rng.Next()).ToList();

            if (opts.All(o => !o.IsCorrect))
            {
                var first = opts[0];
                opts[0] = (first.Text, true);
            }

            list.Add((m, opts));
        }

        if (ShuffleQuestions)
            list = list.OrderBy(_ => rng.Next()).ToList();

        Questions = list;

        // állapot alaphelyzet
        CurrentIndex = 0;
        Score = 0;
        Answered = false;
        SelectedIndex = null;
        WrongShakeIndex = -1;
        ShowCelebration = false;

        // Ha nincs kérdés, ugorjunk befejezett állapotba
        Phase = (Questions.Count > 0) ? PhaseState.Intro : PhaseState.Finished;
    }

    // --- Fázisvezérlés ---
    private async Task StartQuiz()
    {
        if (Total <= 0) return;
        Phase = PhaseState.Quiz;
        // _ = PlaySfx("sfx-level-start");
        StateHasChanged();

        if (!SoundsOn) return;
        await MainLayout.PlayTtsAsync(CurrentQuestionText);
    }

    // --- Események ---
    private async Task OnSelect(int i)
    {
        if (Phase != PhaseState.Quiz || Answered) return;

        SelectedIndex = i;
        Answered = true;

        var correctIndex = CurrentOptions.FindIndex(o => o.IsCorrect);
        if (i == correctIndex)
        {
            Score += 1;

            // visszaírjuk a választ
            Current.Source.QuizSelected = CurrentOptions[i].Text;

            await TriggerSuccess(autoNext: true);
        }
        else
        {
            // visszaírjuk a választ
            if (i >= 0 && i < CurrentOptions.Count)
                Current.Source.QuizSelected = CurrentOptions[i].Text;

            await TriggerWrong(i);
        }
    }


    private async Task TriggerSuccess(bool autoNext)
    {
        await PlaySfx("sfx-answer-success");
        ShowCelebration = true;
        await InvokeAsync(StateHasChanged);
        await Task.Yield();

        if (_confetti is not null) await _confetti.Play();
        if (_badge is not null) await _badge.Play();

        await Task.Delay(1200); // ms
        ShowCelebration = false;
        await InvokeAsync(StateHasChanged);

        if (autoNext && Phase == PhaseState.Quiz) Next();
    }

    private async Task TriggerWrong(int i)
    {
        await PlaySfx("sfx-answer-wrong");
        WrongShakeIndex = i;
        StateHasChanged();
        await Task.Delay(450);
        WrongShakeIndex = -1;
        StateHasChanged();
    }

    private async Task PlaySfx(string id)
    {
        if (!SoundsOn) return;
        try { await jsRuntime.InvokeVoidAsync("quizSfx.play", id); } catch { /* ignore */ }
    }


    private async Task Next()
    {
        var rng = new Random();
        QuestionLady = rng.Next(2) == 0;

        if (!Answered || Phase != PhaseState.Quiz) return;

        if (CurrentIndex < Questions.Count - 1)
        {
            CurrentIndex++;
            Answered = false;
            SelectedIndex = null;
            WrongShakeIndex = -1;

            if (!SoundsOn) return;
            await MainLayout.PlayTtsAsync(CurrentQuestionText);
        }
        else
        {
            Phase = PhaseState.Finished;
            _ = PlayFinishAnimations();
        }
    }


    private async Task PlayFinishAnimations()
    {
        await PlaySfx("sfx-level-complete");
        await InvokeAsync(StateHasChanged);
        await Task.Yield();
        if (_confetti is not null) await _confetti.Play();
        if (_trophy is not null) await _trophy.Play();
    }


    private async Task ResetAll()
    {
        if (string.IsNullOrEmpty(Course.CourseTitle) && OnRequestDailyRefresh.HasDelegate)
        {
            await OnRequestDailyRefresh.InvokeAsync(); // parent újraválogat max 10-et
                                                       // A parent frissíti az Items-et (Quizzes), ezért itt csak újraépítünk:
            RebuildQuestions(Items ?? Enumerable.Empty<QuizModel>());
        }
        else
        {
            RebuildQuestions(Items); // nem napi mód: lokálisan újrakever
        }

        Phase = PhaseState.Intro;
    }

    private void CancelQuiz()
    {
        // nincs OnFinish hívás, nincs mentés
        RebuildQuestions(Items);      // visszaállít és újrakever, ahogy az „Újrakezdés” is
        Phase = PhaseState.Intro;     // vissza az intróra
    }

    private async Task Finish()
    {
        // Kimeneti összesítés UserQuizModel-ként
        var model = new UserQuizModel
        {
            CourseId = Items?.FirstOrDefault()?.CourseId ?? 0,
            QuizQuestion = Total,
            QuizResult = Score,
            DailyQuiz = string.IsNullOrEmpty(Course.CourseTitle) ? true : false, // ha szükséges, kívülről is jöhet
            ModificationDate = DateTime.Now
        };

        if (OnFinish.HasDelegate)
            await OnFinish.InvokeAsync(model);
    }

    // --- Segédek ---
    private static bool EqualsCI(string a, string b)
        => string.Equals(a?.Trim(), b?.Trim(), StringComparison.OrdinalIgnoreCase);
}
