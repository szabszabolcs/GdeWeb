@using GdeWebLA09.Services
@using GdeWebLA09Models
@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase

@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvider

<CascadingValue Value="this">
    <div class="page">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-4">
                <Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
                    <Authorized>
                        <div class="top-bar">
                            @("Üdvözöllek " + @loggedUser.FirstName)
                            <a href="#" @onclick="Logout">Kijelentkezés</a>
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="top-bar">
                            <a href="/signin">Bejelentkezés</a>
                        </div>
                    </NotAuthorized>
                </Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
            </div>

            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>
</CascadingValue>

<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    //LOGGED USER
    public LoginUserModel loggedUser = new LoginUserModel();


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RefreshLoggedUser();
            if (loggedUser.Id > 0)
            {
                navigationManager.NavigateTo("/", true);
            }
            else
            {
                await ((CustomAuthentication)authenticationStateProvider).MarkUserAsLoggedOut();
                await RefreshLoggedUser();
            }

            StateHasChanged();
        }

        await base.OnAfterRenderAsync(firstRender);
    }


    /// <summary>
    /// LOGOUT
    /// </summary>
    #region LOGOUT
    public async Task Logout()
    {
        await ((CustomAuthentication)authenticationStateProvider).MarkUserAsLoggedOut();
        await RefreshLoggedUser();
        //await GoTo("/");
        navigationManager.NavigateTo("/", true);
    }
    #endregion

    /// <summary>
    /// REFRESH LOGGED USER
    /// </summary>
    #region REFRESH LOGGED USER
    public async Task RefreshLoggedUser()
    {
        loggedUser = await ((CustomAuthentication)authenticationStateProvider).GetAuthenticatedUserAsync();

        StateHasChanged();
    }
    #endregion
}
