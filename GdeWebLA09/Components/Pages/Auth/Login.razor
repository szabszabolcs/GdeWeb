@page "/signin"
@using GdeWebLA09.Components.Layout
@using GdeWebLA09.Services
@using Microsoft.AspNetCore.Authentication.Cookies
@using Microsoft.AspNetCore.Authorization
@attribute [AllowAnonymous]


@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using GdeWebLA09Models
@using GdeWebLA09.Interfaces
@inject IAuthService AuthService
@inject AuthenticationStateProvider authenticationStateProvider
@inject NavigationManager navigationManager
@inject ILogger<Login> Logger

<style>
    .signin-wrap {
        max-width: 420px;
        margin: 8vh auto;
        padding: 24px;
        border: 1px solid #ddd;
        border-radius: 12px;
    }

    .form-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 14px;
    }

        .form-row label {
            font-weight: 600;
        }

    input[type="text"], input[type="password"] {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }

    .btn-primary {
        padding: 10px 16px;
        border: 0;
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-link {
        margin-left: 8px;
        background: transparent;
        border: 0;
        cursor: pointer;
        text-decoration: underline;
    }

    .alert-error {
        background: #ffecec;
        border: 1px solid #ffb3b3;
        color: #900;
        padding: 10px 12px;
        border-radius: 8px;
        margin-bottom: 12px;
    }

    .helper-links {
        margin-top: 12px;
        color: #666;
    }

        .helper-links a {
            text-decoration: underline;
        }
</style>

<PageTitle>Bejelentkezés</PageTitle>

<div class="signin-wrap">
    <h1>Bejelentkezés</h1>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert-error">@((MarkupString)ErrorMessage)</div>
    }

    <EditForm Model="@Model" OnValidSubmit="@OnSubmitAsync">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-row">
            <label for="email">E-mail</label>
            <InputText id="email" @bind-Value="Model.Email" />
            <ValidationMessage For="@(() => Model.Email)" />
        </div>

        <div class="form-row">
            <label for="password">Jelszó</label>
            <InputText id="password" type="@(_showPw ? "text" : "password")" @bind-Value="Model.Password" />
            <button type="button" class="btn-link" @onclick="TogglePw">@(_showPw ? "Elrejt" : "Mutat")</button>
            <ValidationMessage For="@(() => Model.Password)" />
        </div>

        <button class="btn-primary" disabled="@Busy">Bejelentkezés</button>
    </EditForm>

    <div class="helper-links">
        <a href="/signup">Nincs fiókod? Regisztrálj</a> ·
        <a href="/forgot-password">Elfelejtett jelszó</a>
    </div>
</div>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; } = default!;

    [Parameter] public string? ReturnUrl { get; set; }

    private bool Busy = false;
    private bool _showPw = false;
    private string? ErrorMessage;

    // A form modell (ha már van saját LoginModel osztályod, azt használjuk)
    private LoginForm Model { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        // ha már be vagy lépve, ugorj a dashboardra (vagy a kapott ReturnUrl-re)
        var state = await authenticationStateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            navigationManager.NavigateTo(NormalizeReturnUrl(ReturnUrl));
        }
    }

    private async Task OnSubmitAsync()
    {
        try
        {
            Busy = true;
            ErrorMessage = null;

            // API hívás – a Te IAuthService-ed
            var loginResult = await AuthService.Login(new LoginModel
            {
                Email = Model.Email!,
                Password = Model.Password!
            });

            if (loginResult?.Result?.Success == true && loginResult.Active)
            {
                // Ha van egy korábbi bejelentkezés, akkor előbb kijelentkezik
                await ((CustomAuthentication)authenticationStateProvider).MarkUserAsLoggedOut();
                await MainLayout.RefreshLoggedUser();

                // Token eltárolása és Claims beállítása
                await ((CustomAuthentication)authenticationStateProvider).MarkUserAsAuthenticated(loginResult);
                await MainLayout.RefreshLoggedUser();
              

                // redirect
                //navigationManager.NavigateTo(NormalizeReturnUrl(ReturnUrl), forceLoad: false);
                navigationManager.NavigateTo("/");
            }
            else
            {
                ErrorMessage = loginResult?.Result?.ErrorMessage ?? "Hibás bejelentkezés.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Login hiba");
            ErrorMessage = "Váratlan hiba történt a bejelentkezés során.";
        }
        finally
        {
            Busy = false;
        }
    }

    private void TogglePw() => _showPw = !_showPw;

    private static string NormalizeReturnUrl(string? url)
        => string.IsNullOrWhiteSpace(url) ? "/dashboard" : url;

    // Egyszerű DataAnnotations-os űrlapmodell
    private sealed class LoginForm
    {
        [Required(ErrorMessage = "Az e-mail megadása kötelező.")]
        [EmailAddress(ErrorMessage = "Érvénytelen e-mail formátum.")]
        public string? Email { get; set; }

        [Required(ErrorMessage = "A jelszó megadása kötelező.")]
        [StringLength(100, MinimumLength = 6, ErrorMessage = "A jelszó legalább 6 karakter.")]
        public string? Password { get; set; }
    }
}
